<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÂÆ∂Ë®à„ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„Éâ ‚Äî Insight-OS Finance</title>
    <meta name="description" content="ÂÆ∂Ë®à„ÅÆÂèéÊîØ„Éª„É©„Ç§„Éï„Ç§„Éô„É≥„Éà‰∫àÊ∏¨„ÇíÂèØË¶ñÂåñ„Åô„Çã„ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„Éâ">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Space+Grotesk:wght@400;500;700&display=swap"
        rel="stylesheet">
    <style>
        :root {
            --bg-dark: #0a0f1e;
            --card-bg: rgba(15, 23, 42, 0.85);
            --border-color: rgba(56, 189, 248, 0.12);
            --text-main: #e2e8f0;
            --text-muted: #94a3b8;
            --accent-primary: #38bdf8;
            --accent-green: #34d399;
            --accent-yellow: #fbbf24;
            --accent-red: #f87171;
            --accent-purple: #818cf8;
            --glass-blur: blur(16px);
            --radius: 20px;
        }

        *,
        *::before,
        *::after {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg-dark);
            color: var(--text-main);
            min-height: 100vh;
            background-image:
                radial-gradient(ellipse at 20% 40%, rgba(56, 189, 248, 0.06) 0%, transparent 60%),
                radial-gradient(ellipse at 80% 60%, rgba(129, 140, 248, 0.05) 0%, transparent 60%);
        }

        /* ‚îÄ‚îÄ‚îÄ Header ‚îÄ‚îÄ‚îÄ */
        header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 20px 32px;
            border-bottom: 1px solid var(--border-color);
            background: rgba(10, 15, 30, 0.8);
            backdrop-filter: var(--glass-blur);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 14px;
        }

        .logo {
            font-family: 'Space Grotesk', sans-serif;
            font-size: 18px;
            font-weight: 700;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-purple));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .badge {
            font-size: 11px;
            padding: 3px 8px;
            border-radius: 20px;
            background: rgba(52, 211, 153, 0.12);
            color: var(--accent-green);
            border: 1px solid rgba(52, 211, 153, 0.2);
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .nav-back {
            font-size: 12px;
            color: var(--text-muted);
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 14px;
            border: 1px solid var(--border-color);
            border-radius: 20px;
            transition: all 0.2s;
        }

        .nav-back:hover {
            color: var(--accent-primary);
            border-color: rgba(56, 189, 248, 0.4);
        }

        #last-updated {
            font-size: 11px;
            color: var(--text-muted);
        }

        /* ‚îÄ‚îÄ‚îÄ Layout ‚îÄ‚îÄ‚îÄ */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 32px 24px 80px;
        }

        .page-title {
            font-family: 'Space Grotesk', sans-serif;
            font-size: 26px;
            font-weight: 700;
            margin-bottom: 6px;
        }

        .page-subtitle {
            font-size: 13px;
            color: var(--text-muted);
            margin-bottom: 40px;
        }

        /* ‚îÄ‚îÄ‚îÄ Summary Bar ‚îÄ‚îÄ‚îÄ */
        .summary-bar {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 40px;
        }

        .kpi-card {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: var(--radius);
            padding: 20px 24px;
            backdrop-filter: var(--glass-blur);
            transition: transform 0.2s, border-color 0.2s;
        }

        .kpi-card:hover {
            transform: translateY(-2px);
            border-color: rgba(56, 189, 248, 0.3);
        }

        .kpi-label {
            font-size: 11px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.08em;
            margin-bottom: 8px;
        }

        .kpi-value {
            font-family: 'Space Grotesk', sans-serif;
            font-size: 24px;
            font-weight: 700;
        }

        .kpi-value.green {
            color: var(--accent-green);
        }

        .kpi-value.yellow {
            color: var(--accent-yellow);
        }

        .kpi-value.red {
            color: var(--accent-red);
        }

        .kpi-value.blue {
            color: var(--accent-primary);
        }

        .kpi-sub {
            font-size: 11px;
            color: var(--text-muted);
            margin-top: 4px;
        }

        /* ‚îÄ‚îÄ‚îÄ Panel ‚îÄ‚îÄ‚îÄ */
        .panel {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: var(--radius);
            padding: 28px;
            margin-bottom: 28px;
            backdrop-filter: var(--glass-blur);
        }

        .panel-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 24px;
        }

        .panel-icon {
            font-size: 18px;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 12px;
        }

        .panel-title {
            font-family: 'Space Grotesk', sans-serif;
            font-size: 16px;
            font-weight: 600;
        }

        /* ‚îÄ‚îÄ‚îÄ Credit Card Calendar ‚îÄ‚îÄ‚îÄ */
        .cal-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 6px;
        }

        .cal-day {
            min-height: 70px;
            border-radius: 10px;
            border: 1px solid var(--border-color);
            padding: 8px;
            font-size: 10px;
            background: rgba(255, 255, 255, 0.015);
            transition: background 0.2s;
        }

        .cal-day.has-card {
            border-color: rgba(56, 189, 248, 0.3);
            background: rgba(56, 189, 248, 0.04);
        }

        .cal-day-num {
            font-weight: 600;
            font-size: 12px;
            color: var(--text-muted);
            margin-bottom: 4px;
        }

        .cal-day.has-card .cal-day-num {
            color: var(--accent-primary);
        }

        .cal-card-tag {
            font-size: 9px;
            background: rgba(56, 189, 248, 0.1);
            color: var(--accent-primary);
            border-radius: 4px;
            padding: 2px 4px;
            margin-bottom: 2px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            display: block;
        }

        /* ‚îÄ‚îÄ‚îÄ „É©„Ç§„Éï„Ç§„Éô„É≥„Éà „Çø„Ç§„É†„É©„Ç§„É≥ ‚îÄ‚îÄ‚îÄ */
        .timeline {
            display: flex;
            flex-direction: column;
            gap: 0;
            position: relative;
        }

        .timeline::before {
            content: '';
            position: absolute;
            left: 52px;
            top: 24px;
            bottom: 24px;
            width: 1px;
            background: linear-gradient(to bottom, rgba(56, 189, 248, 0.3), rgba(129, 140, 248, 0.1));
        }

        .tl-item {
            display: grid;
            grid-template-columns: 104px 1fr;
            gap: 20px;
            padding: 16px 0;
            position: relative;
            animation: fadeInUp 0.4s ease both;
        }

        .tl-item:nth-child(1) {
            animation-delay: 0s;
        }

        .tl-item:nth-child(2) {
            animation-delay: 0.05s;
        }

        .tl-item:nth-child(3) {
            animation-delay: 0.10s;
        }

        .tl-item:nth-child(4) {
            animation-delay: 0.15s;
        }

        .tl-item:nth-child(5) {
            animation-delay: 0.20s;
        }

        .tl-item:nth-child(6) {
            animation-delay: 0.25s;
        }

        .tl-item:nth-child(7) {
            animation-delay: 0.30s;
        }

        .tl-item:nth-child(8) {
            animation-delay: 0.35s;
        }

        .tl-item:nth-child(9) {
            animation-delay: 0.40s;
        }

        .tl-item:nth-child(10) {
            animation-delay: 0.45s;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(8px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .tl-left {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
            padding-top: 4px;
        }

        .tl-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            border: 2px solid var(--accent-primary);
            background: var(--bg-dark);
            position: relative;
            z-index: 1;
            flex-shrink: 0;
        }

        .tl-dot.c-high {
            border-color: var(--accent-primary);
            background: rgba(56, 189, 248, 0.2);
        }

        .tl-dot.c-mid {
            border-color: var(--accent-yellow);
            background: rgba(251, 191, 36, 0.2);
        }

        .tl-dot.c-low {
            border-color: var(--text-muted);
            background: rgba(148, 163, 184, 0.1);
        }

        .tl-timing {
            font-size: 10px;
            color: var(--text-muted);
            text-align: center;
            line-height: 1.4;
        }

        .tl-body {
            padding: 14px 18px;
            border-radius: 14px;
            border: 1px solid var(--border-color);
            background: rgba(255, 255, 255, 0.02);
            transition: border-color 0.2s, background 0.2s;
        }

        .tl-body:hover {
            border-color: rgba(56, 189, 248, 0.25);
            background: rgba(56, 189, 248, 0.03);
        }

        .tl-header {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            gap: 12px;
            margin-bottom: 6px;
        }

        .tl-event {
            font-weight: 600;
            font-size: 14px;
            line-height: 1.4;
        }

        .tl-meta {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-shrink: 0;
        }

        .tl-cost {
            font-family: 'Space Grotesk', sans-serif;
            font-size: 14px;
            font-weight: 600;
            color: var(--accent-yellow);
            white-space: nowrap;
        }

        .certainty-badge {
            font-size: 10px;
            padding: 2px 8px;
            border-radius: 20px;
            white-space: nowrap;
        }

        .certainty-badge.high {
            background: rgba(56, 189, 248, 0.12);
            color: var(--accent-primary);
            border: 1px solid rgba(56, 189, 248, 0.2);
        }

        .certainty-badge.mid {
            background: rgba(251, 191, 36, 0.12);
            color: var(--accent-yellow);
            border: 1px solid rgba(251, 191, 36, 0.2);
        }

        .certainty-badge.low {
            background: rgba(148, 163, 184, 0.12);
            color: var(--text-muted);
            border: 1px solid rgba(148, 163, 184, 0.2);
        }

        .tl-category {
            font-size: 10px;
            padding: 2px 8px;
            border-radius: 10px;
            background: rgba(129, 140, 248, 0.12);
            color: var(--accent-purple);
            margin-right: 4px;
        }

        .tl-note {
            font-size: 12px;
            color: var(--text-muted);
            margin-top: 6px;
            line-height: 1.6;
        }

        /* ‚îÄ‚îÄ‚îÄ „Ç´„Éº„ÉâÂà•Ë´ãÊ±ÇÊòéÁ¥∞ ‚îÄ‚îÄ‚îÄ */
        .charges-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
        }

        .charges-tab {
            font-size: 12px;
            padding: 6px 16px;
            border-radius: 20px;
            border: 1px solid var(--border-color);
            background: transparent;
            color: var(--text-muted);
            cursor: pointer;
            transition: all 0.2s;
            font-family: 'Inter', sans-serif;
        }

        .charges-tab.active {
            background: rgba(56, 189, 248, 0.12);
            color: var(--accent-primary);
            border-color: rgba(56, 189, 248, 0.3);
        }

        .charges-tab:hover:not(.active) {
            border-color: rgba(56, 189, 248, 0.2);
            color: var(--text-main);
        }

        .card-row {
            display: grid;
            grid-template-columns: 130px 1fr 90px;
            align-items: center;
            gap: 12px;
            padding: 10px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.03);
        }

        .card-row:last-child {
            border-bottom: none;
        }

        .card-name {
            font-size: 13px;
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .card-bar-wrap {
            height: 18px;
            border-radius: 6px;
            background: rgba(255, 255, 255, 0.03);
            overflow: hidden;
        }

        .card-bar {
            height: 100%;
            border-radius: 6px;
            background: linear-gradient(90deg, rgba(56, 189, 248, 0.5), rgba(129, 140, 248, 0.4));
            transition: width 0.6s ease;
            min-width: 2px;
        }

        .card-amount {
            font-family: 'Space Grotesk', sans-serif;
            font-size: 13px;
            font-weight: 600;
            color: var(--accent-primary);
            text-align: right;
        }

        .card-amount.zero {
            color: var(--text-muted);
            opacity: 0.4;
        }

        .charges-total {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 14px 0 0;
            margin-top: 8px;
            border-top: 1px solid var(--border-color);
        }

        .charges-total-label {
            font-size: 12px;
            color: var(--text-muted);
            font-weight: 500;
        }

        .charges-total-value {
            font-family: 'Space Grotesk', sans-serif;
            font-size: 18px;
            font-weight: 700;
            color: var(--accent-yellow);
        }

        /* ‚îÄ‚îÄ‚îÄ No Data State ‚îÄ‚îÄ‚îÄ */
        .no-data {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-muted);
        }

        .no-data .icon {
            font-size: 40px;
            margin-bottom: 12px;
        }

        .no-data .title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--text-main);
        }

        .no-data .desc {
            font-size: 13px;
            line-height: 1.7;
        }

        /* ‚îÄ‚îÄ‚îÄ Tooltip ‚îÄ‚îÄ‚îÄ */
        .tooltip {
            position: fixed;
            background: rgba(10, 15, 30, 0.97);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 10px 14px;
            font-size: 12px;
            color: var(--text-main);
            pointer-events: none;
            z-index: 9999;
            max-width: 220px;
            line-height: 1.6;
            display: none;
        }

        @media (max-width: 768px) {
            .summary-bar {
                grid-template-columns: 1fr 1fr;
            }

            .cal-grid {
                grid-template-columns: repeat(4, 1fr);
            }

            .tl-item {
                grid-template-columns: 80px 1fr;
                gap: 12px;
            }

            .timeline::before {
                left: 40px;
            }
        }
    </style>
</head>

<body>
    <header>
        <div class="header-left">
            <div class="logo">üí¥ Finance</div>
            <div class="badge">Insight-OS</div>
        </div>
        <div class="header-right">
            <a href="dashboard.html" class="nav-back">‚Üê „ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„Éâ„Å∏</a>
            <div id="last-updated"></div>
        </div>
    </header>

    <main class="container">
        <h1 class="page-title">ÂÆ∂Ë®à„ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„Éâ</h1>
        <p class="page-subtitle" id="data-date">„Éá„Éº„Çø„ÇíË™≠„ÅøËæº„Åø‰∏≠...</p>

        <!-- KPI „Çµ„Éû„É™„Éº -->
        <div class="summary-bar" id="summary-bar">
            <div class="no-data" style="grid-column:1/-1; padding: 30px;">
                <div class="icon">üìÇ</div>
                <div class="title">„Éá„Éº„ÇøÊú™Ë®≠ÂÆö</div>
                <div class="desc">finance_report.json „ÅåË™≠„ÅøËæº„ÇÅ„Åæ„Åõ„Çì„Åß„Åó„Åü„ÄÇ</div>
            </div>
        </div>

        <!-- „Ç´„Éº„ÉâÂà•Ë´ãÊ±ÇÊòéÁ¥∞ -->
        <div class="panel">
            <div class="panel-header">
                <div class="panel-icon" style="background:rgba(56,189,248,0.12);color:#38bdf8">üí≥</div>
                <div class="panel-title">„Ç´„Éº„ÉâÂà•Ë´ãÊ±ÇÊòéÁ¥∞</div>
            </div>
            <div id="card-charges-tabs" class="charges-tabs"></div>
            <div id="card-charges-body">
                <div class="no-data" style="padding:30px">
                    <div class="icon">üí≥</div>
                    <div class="title">Ë´ãÊ±Ç„Éá„Éº„Çø„Å™„Åó</div>
                    <div class="desc">Êó•Ë®ò„Å´„ÇØ„É¨„Ç´Ë´ãÊ±ÇÈ°ç„ÇíË®òËºâ„Åô„Çã„Å®Ëá™Âãï„ÅßÂèçÊò†„Åï„Çå„Åæ„Åô„ÄÇ</div>
                </div>
            </div>
        </div>

        <!-- „É©„Ç§„Éï„Ç§„Éô„É≥„Éà‰∫àÊ∏¨ -->
        <div class="panel">
            <div class="panel-header">
                <div class="panel-icon" style="background:rgba(129,140,248,0.12);color:#818cf8">üîÆ</div>
                <div class="panel-title">„É©„Ç§„Éï„Ç§„Éô„É≥„Éà‰∫àÊ∏¨„Çø„Ç§„É†„É©„Ç§„É≥</div>
            </div>
            <div id="life-events-panel" class="timeline">
                <div class="no-data">
                    <div class="icon">üìÖ</div>
                    <div class="title">‰∫àÊ∏¨„Éá„Éº„Çø„Å™„Åó</div>
                    <div class="desc">ÂàÜÊûê„Çπ„ÇØ„É™„Éó„Éà„ÇíÂÆüË°å„Åô„Çã„Å®„É©„Ç§„Éï„Ç§„Éô„É≥„Éà„ÅÆ‰∫àÊ∏¨„ÅåË°®Á§∫„Åï„Çå„Åæ„Åô„ÄÇ</div>
                </div>
            </div>
        </div>

        <!-- 2„Ç´„É©„É†: ÂèéÊîØ„Ç∞„É©„Éï + „ÇØ„É¨„Ç´„Ç´„É¨„É≥„ÉÄ„Éº -->
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:28px;margin-bottom:28px;" id="two-col">
            <!-- ÊúàÊ¨°ÂèéÊîØ -->
            <div class="panel">
                <div class="panel-header">
                    <div class="panel-icon" style="background:rgba(52,211,153,0.12);color:#34d399">üìä</div>
                    <div class="panel-title">ÊúàÊ¨°ÂèéÊîØ</div>
                </div>
                <svg id="income-chart" width="100%" height="200"></svg>
            </div>
            <!-- „ÇØ„É¨„Ç´ÂºïËêΩ„Ç´„É¨„É≥„ÉÄ„Éº -->
            <div class="panel">
                <div class="panel-header">
                    <div class="panel-icon" style="background:rgba(129,140,248,0.12);color:#818cf8">üìÖ</div>
                    <div class="panel-title">„ÇØ„É¨„Ç´ÂºïËêΩ„Ç´„É¨„É≥„ÉÄ„Éº</div>
                </div>
                <div id="calendar-panel" class="cal-grid"></div>
            </div>
        </div>
    </main>

    <div id="tooltip" class="tooltip"></div>

    <script>
        const tooltip = document.getElementById('tooltip');
        function fmt(n) { return n != null ? n.toLocaleString('ja-JP') + 'ÂÜÜ' : '‚Äî'; }
        function showTooltip(e, html) {
            tooltip.innerHTML = html; tooltip.style.display = 'block';
            tooltip.style.left = (e.clientX + 14) + 'px'; tooltip.style.top = (e.clientY - 10) + 'px';
        }
        function hideTooltip() { tooltip.style.display = 'none'; }

        // ‚îÄ‚îÄ‚îÄ KPI„Çµ„Éû„É™„Éº ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function renderSummary(r) {
            const s = r.summary;
            const surplusColor = s.monthly_surplus >= 0 ? 'green' : 'red';
            const rateColor = s.savings_rate_pct >= 10 ? 'green' : s.savings_rate_pct >= 5 ? 'yellow' : 'red';
            document.getElementById('summary-bar').innerHTML = [
                { label: 'ÊúàÂèéÂêàË®à', value: fmt(s.monthly_income), color: 'blue', sub: 'ÂèéÂÖ•' },
                { label: 'ÊúàÊ¨°Âõ∫ÂÆöË≤ª', value: fmt(s.monthly_fixed_costs), color: 'yellow', sub: 'ÂÆ∂Ë≥É„Éª‰øùÈô∫„Å™„Å©' },
                { label: 'ÊúàÊ¨°‰ΩôÂâ∞', value: fmt(s.monthly_surplus), color: surplusColor, sub: s.note || '' },
                { label: 'Ë≤ØËìÑÁéá', value: s.savings_rate_pct + '%', color: rateColor, sub: s.note || '' },
            ].map(k => `
                <div class="kpi-card">
                    <div class="kpi-label">${k.label}</div>
                    <div class="kpi-value ${k.color}">${k.value}</div>
                    <div class="kpi-sub">${k.sub}</div>
                </div>
            `).join('');
        }

        // ‚îÄ‚îÄ‚îÄ „Ç´„Éº„ÉâÂà•Ë´ãÊ±ÇÊòéÁ¥∞ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function renderCardCharges(r) {
            const data = r.card_charges_by_month || [];
            if (data.length === 0) return;

            const tabsEl = document.getElementById('card-charges-tabs');
            const bodyEl = document.getElementById('card-charges-body');

            function renderMonth(idx) {
                const m = data[idx];
                const maxAmt = Math.max(...m.cards.map(c => c.amount), 1);
                let html = '';
                m.cards.forEach(c => {
                    const pct = Math.max((c.amount / maxAmt) * 100, 1);
                    const zeroClass = c.amount === 0 ? ' zero' : '';
                    html += `
                        <div class="card-row">
                            <div class="card-name" title="${c.name}">${c.name}</div>
                            <div class="card-bar-wrap">
                                <div class="card-bar" style="width:${pct}%"></div>
                            </div>
                            <div class="card-amount${zeroClass}">${fmt(c.amount)}</div>
                        </div>
                    `;
                });
                html += `
                    <div class="charges-total">
                        <span class="charges-total-label">ÂêàË®à</span>
                        <span class="charges-total-value">${fmt(m.total)}</span>
                    </div>
                `;
                bodyEl.innerHTML = html;
            }

            // „Çø„Éñ„ÇíÁîüÊàê
            tabsEl.innerHTML = data.map((m, i) => {
                const label = m.month.replace(/^(\d{4})-(\d{2})$/, '$1Âπ¥$2Êúà');
                const active = i === 0 ? ' active' : '';
                return `<button class="charges-tab${active}" data-idx="${i}">${label}</button>`;
            }).join('');

            tabsEl.addEventListener('click', e => {
                const btn = e.target.closest('.charges-tab');
                if (!btn) return;
                tabsEl.querySelectorAll('.charges-tab').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                renderMonth(parseInt(btn.dataset.idx));
            });

            renderMonth(0);
        }

        // ‚îÄ‚îÄ‚îÄ „É©„Ç§„Éï„Ç§„Éô„É≥„Éà‰∫àÊ∏¨„Çø„Ç§„É†„É©„Ç§„É≥ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function renderLifeEvents(r) {
            const events = r.life_events_forecast || [];
            if (events.length === 0) return;

            const certClass = { 'È´ò': 'high', '‰∏≠': 'mid', '‰Ωé': 'low' };
            const certLabel = { 'È´ò': 'Á¢∫Â∫¶:È´ò', '‰∏≠': 'Á¢∫Â∫¶:‰∏≠', '‰Ωé': 'Á¢∫Â∫¶:‰Ωé' };

            document.getElementById('life-events-panel').innerHTML = events.map(ev => {
                const cc = certClass[ev.certainty] || 'low';
                const cl = certLabel[ev.certainty] || ev.certainty;
                const costStr = ev.estimated_cost != null ? fmt(ev.estimated_cost) : 'ÈáëÈ°çÊú™ÂÆö';
                const monthsStr = ev.months_until != null
                    ? (ev.months_until <= 0 ? '‰ªäÊúà' : ev.months_until + '„É∂ÊúàÂæå')
                    : '';
                return `
                    <div class="tl-item">
                        <div class="tl-left">
                            <div class="tl-dot c-${cc}"></div>
                            <div class="tl-timing">${monthsStr}<br>${ev.timing || ''}</div>
                        </div>
                        <div class="tl-body">
                            <div class="tl-header">
                                <div>
                                    <span class="tl-category">${ev.category || '„Åù„ÅÆ‰ªñ'}</span>
                                    <span class="tl-event">${ev.event}</span>
                                </div>
                                <div class="tl-meta">
                                    <span class="tl-cost">${costStr}</span>
                                    <span class="certainty-badge ${cc}">${cl}</span>
                                </div>
                            </div>
                            ${ev.note ? `<div class="tl-note">${ev.note}</div>` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // ‚îÄ‚îÄ‚îÄ ÊúàÊ¨°ÂèéÊîØÊ£í„Ç∞„É©„Éï ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function renderIncomeChart(r) {
            const s = r.summary;
            const bars = [
                { label: 'ÊúàÂèé', value: s.monthly_income, color: '#38bdf8' },
                { label: 'Âõ∫ÂÆöË≤ª', value: s.monthly_fixed_costs, color: '#f87171' },
                { label: 'Â§âÂãïË≤ª', value: s.monthly_variable_estimate, color: '#fbbf24', note: s.note },
            ].filter(b => b.value > 0);

            const svgEl = document.getElementById('income-chart');
            const W = svgEl.parentElement.offsetWidth - 56;
            const H = 200;
            const pad = { top: 10, right: 10, bottom: 40, left: 10 };
            const innerW = W - pad.left - pad.right;
            const innerH = H - pad.top - pad.bottom;
            const max = Math.max(...bars.map(b => b.value));
            const barW = innerW / bars.length * 0.6;
            const gap = innerW / bars.length;

            svgEl.setAttribute('viewBox', `0 0 ${W} ${H}`);
            svgEl.innerHTML = '';
            const ns = 'http://www.w3.org/2000/svg';
            const g = document.createElementNS(ns, 'g');
            g.setAttribute('transform', `translate(${pad.left},${pad.top})`);
            svgEl.appendChild(g);

            bars.forEach((b, i) => {
                const bH = (b.value / max) * innerH;
                const x = gap * i + (gap - barW) / 2;
                const y = innerH - bH;
                const rect = document.createElementNS(ns, 'rect');
                rect.setAttribute('x', x); rect.setAttribute('y', y);
                rect.setAttribute('width', barW); rect.setAttribute('height', bH);
                rect.setAttribute('fill', b.color); rect.setAttribute('rx', 4);
                rect.setAttribute('opacity', '0.85'); rect.style.cursor = 'pointer';
                rect.addEventListener('mousemove', e => showTooltip(e, `<strong>${b.label}</strong><br>${fmt(b.value)}${b.note ? `<br>(${b.note})` : ''}`));
                rect.addEventListener('mouseleave', hideTooltip);
                g.appendChild(rect);
                const lbl = document.createElementNS(ns, 'text');
                lbl.setAttribute('x', x + barW / 2); lbl.setAttribute('y', innerH + 18);
                lbl.setAttribute('text-anchor', 'middle');
                lbl.setAttribute('fill', 'rgba(148,163,184,0.8)'); lbl.setAttribute('font-size', '10');
                lbl.textContent = b.label;
                g.appendChild(lbl);
            });
        }

        // ‚îÄ‚îÄ‚îÄ „ÇØ„É¨„Ç´„Ç´„É¨„É≥„ÉÄ„Éº ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function renderCalendar(r) {
            const cc = r.credit_card_calendar || [];
            const cardsByDay = {};
            cc.forEach(entry => { cardsByDay[entry.day] = entry.cards; });
            const el = document.getElementById('calendar-panel');
            let html = '';
            for (let d = 1; d <= 31; d++) {
                const cards = cardsByDay[d];
                if (cards) {
                    html += `<div class="cal-day has-card">
                        <div class="cal-day-num">${d}Êó•</div>
                        ${cards.map(c => `<span class="cal-card-tag" title="${c.name} (${c.bank})">${c.name}</span>`).join('')}
                    </div>`;
                } else {
                    html += `<div class="cal-day"><div class="cal-day-num" style="opacity:0.3">${d}</div></div>`;
                }
            }
            el.innerHTML = html;
        }

        // ‚îÄ‚îÄ‚îÄ „É°„Ç§„É≥ÂàùÊúüÂåñ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function showNoData() {
            const dateEl = document.getElementById('data-date');
            if (dateEl) dateEl.textContent = 'finance_report.json „ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„Åß„Åó„Åü';
        }

        function applyReport(r) {
            const updEl = document.getElementById('last-updated');
            const dateEl = document.getElementById('data-date');
            if (updEl && r.generated_at) {
                updEl.textContent = 'Êõ¥Êñ∞: ' + new Date(r.generated_at).toLocaleString('ja-JP');
            }
            if (dateEl) dateEl.textContent = 'ÂÆ∂Ë®à„Ç≥„É≥„ÉÜ„Ç≠„Çπ„Éà„Éï„Ç°„Ç§„É´„Åã„ÇâÁîüÊàê„Åï„Çå„Åü„Éá„Éº„Çø„Åß„Åô';
            renderSummary(r);
            renderCardCharges(r);
            renderLifeEvents(r);
            renderIncomeChart(r);
            renderCalendar(r);
        }

        document.addEventListener('DOMContentLoaded', () => {
            fetch('finance_report.json?t=' + Date.now())
                .then(res => { if (!res.ok) throw new Error('not found'); return res.json(); })
                .then(r => applyReport(r))
                .catch(() => showNoData());
        });
    </script>
</body>

</html>