name: Blog Auto-Publish Pipeline

on:
  repository_dispatch:
    types: [pomera-blog]
  workflow_dispatch:
    inputs:
      draft_file:
        description: 'blog_drafts/ å†…ã®ãƒ•ã‚¡ã‚¤ãƒ«åã‚’æŒ‡å®šã—ã¦æ‰‹å‹•å®Ÿè¡Œ'
        required: false
        default: ''
        type: string

jobs:
  blog:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests

      - name: Save Blog Draft from Payload
        if: ${{ github.event_name == 'repository_dispatch' }}
        id: save_draft
        env:
          BLOG_BODY: ${{ github.event.client_payload.body }}
          BLOG_SUBJECT: ${{ github.event.client_payload.subject }}
        run: |
          echo "ğŸ“¬ payloadã‹ã‚‰ãƒ–ãƒ­ã‚°è‰æ¡ˆã‚’å–å¾—ä¸­..."
          echo "ğŸ” ãƒ‡ãƒãƒƒã‚°: BLOG_SUBJECT length=$(echo -n "$BLOG_SUBJECT" | wc -c)"
          echo "ğŸ” ãƒ‡ãƒãƒƒã‚°: BLOG_BODY length=$(echo -n "$BLOG_BODY" | wc -c)"
          mkdir -p blog_drafts

          if [ -n "$BLOG_BODY" ]; then
            SAFE_SUBJECT=$(echo "$BLOG_SUBJECT" | sed 's/[\/\*\?\:\"<>\|\\]//g' | cut -c1-50)
            DATE_PREFIX=$(date +%Y%m%d)
            DRAFT_FILE="blog_drafts/${DATE_PREFIX}_${SAFE_SUBJECT}.txt"
            printf '%s' "$BLOG_BODY" > "$DRAFT_FILE"
            echo "âœ… payloadã‹ã‚‰è‰æ¡ˆã‚’ä¿å­˜ã—ã¾ã—ãŸ: $DRAFT_FILE"
            echo "   æ–‡å­—æ•°: $(wc -c < "$DRAFT_FILE") bytes"
            # â˜… ä»Šå›ä¿å­˜ã—ãŸãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹ã‚’å¾Œç¶šã‚¹ãƒ†ãƒƒãƒ—ã«æ¸¡ã™
            echo "draft_file=$DRAFT_FILE" >> $GITHUB_OUTPUT
          else
            echo "âš ï¸ BLOG_BODYãŒç©ºã§ã™ã€‚å‡¦ç†ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™ã€‚"
            echo "draft_file=" >> $GITHUB_OUTPUT
          fi

      - name: Generate Essay and Publish
        env:
          GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
          HATENA_ID: ${{ secrets.HATENA_ID }}
          HATENA_BLOG_ID: ${{ secrets.HATENA_BLOG_ID }}
          HATENA_API_KEY: ${{ secrets.HATENA_API_KEY }}
          CURRENT_DRAFT: ${{ steps.save_draft.outputs.draft_file || github.event.inputs.draft_file || '' }}
        run: |
          echo "ğŸ”‘ ç’°å¢ƒå¤‰æ•°ãƒã‚§ãƒƒã‚¯:"
          echo "  GOOGLE_API_KEY: $([ -n '${{ secrets.GOOGLE_API_KEY }}' ] && echo 'ã‚»ãƒƒãƒˆæ¸ˆã¿' || echo 'æœªè¨­å®š')"
          echo "  HATENA_ID: ${{ secrets.HATENA_ID }}"
          echo "  HATENA_BLOG_ID: ${{ secrets.HATENA_BLOG_ID }}"
          echo "  HATENA_API_KEY: $([ -n '${{ secrets.HATENA_API_KEY }}' ] && echo 'ã‚»ãƒƒãƒˆæ¸ˆã¿' || echo 'æœªè¨­å®š â† æŠ•ç¨¿ã§ããªã„åŸå› ã®å¯èƒ½æ€§')"

          mkdir -p blog_drafts/processed blog_ready

          # â˜… CURRENT_DRAFTãŒæŒ‡å®šã•ã‚Œã¦ã„ã‚Œã°ãã®ãƒ•ã‚¡ã‚¤ãƒ«ã ã‘å‡¦ç†
          if [ -n "$CURRENT_DRAFT" ] && [ -f "$CURRENT_DRAFT" ]; then
            echo "ğŸ“ Processing (æŒ‡å®šãƒ•ã‚¡ã‚¤ãƒ«): $CURRENT_DRAFT"
            python scripts/blog_article_writer.py "$CURRENT_DRAFT"
            EXIT_CODE=$?
            if [ $EXIT_CODE -ne 0 ]; then
              echo "âš ï¸ å¤±æ•— (exit=$EXIT_CODE): $CURRENT_DRAFT"
            else
              echo "âœ… å®Œäº†: $CURRENT_DRAFT"
            fi
            mv "$CURRENT_DRAFT" blog_drafts/processed/ 2>/dev/null || true
          elif [ -n "$CURRENT_DRAFT" ]; then
            echo "âŒ æŒ‡å®šãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: $CURRENT_DRAFT"
          else
            echo "ğŸ’¤ å‡¦ç†å¯¾è±¡ã®ãƒ–ãƒ­ã‚°è‰æ¡ˆãŒã‚ã‚Šã¾ã›ã‚“ï¼ˆBLOG_BODYãŒç©ºã§ã—ãŸï¼‰"
          fi

          echo "ğŸ“‚ blog_ready/ ã®ç”Ÿæˆçµæœ:"
          ls -la blog_ready/*.md 2>/dev/null | tail -5 || echo "  ãªã—"

      - name: Commit and Push changes
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "Antigravity Blog Bot"
          git add blog_drafts/ || true
          git add blog_ready/ || true
          git add blog_published/ || true
          git add sync_history.txt || true

          git diff --quiet && git diff --staged --quiet || (git commit -m "Auto-blog: Essay generated and published [skip ci]" && git push)
