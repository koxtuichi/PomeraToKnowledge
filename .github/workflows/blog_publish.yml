name: Blog Auto-Publish Pipeline

on:
  repository_dispatch:
    types: [pomera-blog]
  workflow_dispatch:
    inputs:
      draft_file:
        description: 'blog_drafts/ å†…ã®ãƒ•ã‚¡ã‚¤ãƒ«åã‚’æŒ‡å®šã—ã¦æ‰‹å‹•å®Ÿè¡Œ'
        required: false
        default: ''
        type: string

jobs:
  blog:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests

      - name: Save Blog Draft from Payload
        if: ${{ github.event_name == 'repository_dispatch' }}
        env:
          BLOG_BODY: ${{ github.event.client_payload.body }}
          BLOG_SUBJECT: ${{ github.event.client_payload.subject }}
          GMAIL_ACCOUNT: ${{ secrets.GMAIL_ACCOUNT }}
          GMAIL_APP_PASSWORD: ${{ secrets.GMAIL_APP_PASSWORD }}
        run: |
          echo "ğŸ“¬ payloadã‹ã‚‰ãƒ–ãƒ­ã‚°è‰æ¡ˆã‚’å–å¾—ä¸­..."
          echo "ğŸ” ãƒ‡ãƒãƒƒã‚°: BLOG_SUBJECT length=$(echo -n "$BLOG_SUBJECT" | wc -c)"
          echo "ğŸ” ãƒ‡ãƒãƒƒã‚°: BLOG_BODY length=$(echo -n "$BLOG_BODY" | wc -c)"
          mkdir -p blog_drafts

          if [ -n "$BLOG_BODY" ]; then
            # payloadã§æœ¬æ–‡ãŒå±Šã„ãŸå ´åˆ
            SAFE_SUBJECT=$(echo "$BLOG_SUBJECT" | sed 's/[\/\*\?\:\"<>\|\\]//g' | cut -c1-50)
            DATE_PREFIX=$(date +%Y%m%d)
            DRAFT_FILE="blog_drafts/${DATE_PREFIX}_${SAFE_SUBJECT}.txt"
            printf '%s' "$BLOG_BODY" > "$DRAFT_FILE"
            echo "âœ… payloadã‹ã‚‰è‰æ¡ˆã‚’ä¿å­˜ã—ã¾ã—ãŸ: $DRAFT_FILE"
            echo "   æ–‡å­—æ•°: $(wc -c < "$DRAFT_FILE") bytes"
          else
            # ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: Gmailã‹ã‚‰ç›´æ¥å–å¾—ï¼ˆGASãŒbodyã‚’é€ã£ã¦ã„ãªã„å ´åˆï¼‰
            echo "âš ï¸ BLOG_BODYãŒç©ºã€‚Gmailã‹ã‚‰ç›´æ¥å–å¾—ã—ã¾ã™..."
            python scripts/sync_email.py --blog-only
            DRAFT_COUNT=$(ls blog_drafts/*.txt 2>/dev/null | wc -l)
            echo "   Gmailã‹ã‚‰ ${DRAFT_COUNT} ä»¶å–å¾—"
          fi

          echo "ğŸ“‚ blog_drafts/ ã®å†…å®¹:"
          ls -la blog_drafts/*.txt 2>/dev/null || echo "  TXTãƒ•ã‚¡ã‚¤ãƒ«ãªã—"

      - name: Generate Essay and Publish
        env:
          GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
          HATENA_ID: ${{ secrets.HATENA_ID }}
          HATENA_BLOG_ID: ${{ secrets.HATENA_BLOG_ID }}
          HATENA_API_KEY: ${{ secrets.HATENA_API_KEY }}
        run: |
          echo "ğŸ”‘ ç’°å¢ƒå¤‰æ•°ãƒã‚§ãƒƒã‚¯:"
          echo "  GOOGLE_API_KEY: $([ -n '${{ secrets.GOOGLE_API_KEY }}' ] && echo 'ã‚»ãƒƒãƒˆæ¸ˆã¿' || echo 'æœªè¨­å®š')"
          echo "  HATENA_ID: ${{ secrets.HATENA_ID }}"
          echo "  HATENA_BLOG_ID: ${{ secrets.HATENA_BLOG_ID }}"
          echo "  HATENA_API_KEY: $([ -n '${{ secrets.HATENA_API_KEY }}' ] && echo 'ã‚»ãƒƒãƒˆæ¸ˆã¿' || echo 'æœªè¨­å®š â† æŠ•ç¨¿ã§ããªã„åŸå› ã®å¯èƒ½æ€§')"

          # blog_drafts/ å†…ã®æœªå‡¦ç†ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‡¦ç†
          if [ -d "blog_drafts" ] && [ "$(ls -A blog_drafts/*.txt 2>/dev/null)" ]; then
            mkdir -p blog_drafts/processed blog_ready
            for f in blog_drafts/*.txt; do
              echo "ğŸ“ Processing: $f"
              python scripts/blog_article_writer.py "$f"
              EXIT_CODE=$?
              if [ $EXIT_CODE -ne 0 ]; then
                echo "âš ï¸ å¤±æ•— (exit=$EXIT_CODE): $f"
              else
                echo "âœ… å®Œäº†: $f"
              fi
              mv "$f" blog_drafts/processed/ 2>/dev/null || true
              sleep 5
            done
          else
            echo "ğŸ’¤ å‡¦ç†å¯¾è±¡ã®ãƒ–ãƒ­ã‚°è‰æ¡ˆãŒã‚ã‚Šã¾ã›ã‚“"
          fi

          echo "ğŸ“‚ blog_ready/ ã®ç”Ÿæˆçµæœ:"
          ls -la blog_ready/*.md 2>/dev/null | tail -5 || echo "  ãªã—"

      - name: Commit and Push changes
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "Antigravity Blog Bot"
          git add blog_drafts/ || true
          git add blog_ready/ || true
          git add blog_published/ || true
          git add sync_history.txt || true

          git diff --quiet && git diff --staged --quiet || (git commit -m "Auto-blog: Essay generated and published [skip ci]" && git push)
